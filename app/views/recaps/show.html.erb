<!-- Banner with title, author, rating -->
<div class="banner" style="background-image: url(<%= image_url "banner.png" %>);">
  <div class="container">
    <h6><strong>Author:</strong> J.K. Rowling</h6>
    <h1><strong>Your chosen book recap.</strong></h1>
    <% if @recap.ratings.average("star") == nil %>
      <a href="#rating-cards" class="rating-link"><p>Be the first to leave a review!</p></a>
    <% else %>
      <%= render "shared/rating" %>
    <% end %>
  </div>
</div>

<div class="container mt-4">

  <div class="row">
    <div class="container col-lg-9 col-sm-12">
      <h6><strong>Recaped by: <%=@recap.user.username %></strong></h6>
      <ul class="nav nav-pills mb-3" style="display: flex; justify-content: center;" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home" aria-selected="true">Book Description</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" aria-selected="false">Recap Summary</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#pills-contact" type="button" role="tab" aria-controls="pills-contact" aria-selected="false">Key</button>
        </li>
      </ul>

      <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
          <%=@description = @recap.book.description%>
        </div>
        <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
          <%=@recap.summary%>
        </div>
        <div class="tab-pane fade" id="pills-contact" role="tabpanel" aria-labelledby="pills-contact-tab">
          <%@recaps = Recap.where(book_id: @recap.book.id)%>
          <%@recaps.each do |recap|%>
            <%= recap.keypoint%>
          <%end%>
        </div>
      </div>
    </div>

    <!-- Recap cards -->
    <div class="recap-cards col-lg-3">
      <% @recaps = Recap.where(book_id: @recap.book.id) %>
      <%= render "shared/recapcards" %>
    </div>
  </div>

  <!-- Review cards -->
  <div class="review-container" id="rating-cards">
    <div class="row">
      <div class="col-12 col-md-6 col-lg-6">
        <div class="review-header">
          <h3>Reviews on <%= @recap.user.username %>'s recap</h3>
          <button type="button" class="btn-action" data-bs-toggle="modal" data-bs-target="#exampleModal">Add review</button>
        </div>

        <div id="anchor-review">
          <% @recap.ratings.each do |r| %>
            <div class="review-card">
              <p id="rating-<%= r.id %>"></p>
              <div style="display: flex;">
                <div style="margin-right: 10px;">
                  <% if r.user.avatar.attached? %>
                    <%= image_tag r.user.avatar, class: "avatar" %>
                  <% else %>
                    <%= image_tag "default-avatar.png", class: "avatar" %>
                  <% end %>
                </div>
                <div>
                  <h4><%= r.user.username %></h4>
                  <p> <i class="fas fa-star" style="color: #F6AE2D;"></i> <%= r.star.to_f %></p>
                </div>
              </div>
              <p><%= r.comment %></p>
              <% if r.user == current_user %>
                <%= link_to rating_path(r), method: :delete, remote: true, data: { confirm: "Are you sure you want to delete this review?"} do %>
                  <i class="far fa-trash-alt"></i>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal with review form -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Tell us what you think</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <%= simple_form_for([ @recap, @rating ], remote: true) do |f| %>
            <%= f.input :comment, label: "Comment"  %>
            <%= f.input :star, label: "Rating", collection: 0..5 %>
            <%= f.submit "Submit review", class: "btn-action" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!--Delete recap-->
<% if @recap.user == current_user %>
  <%= link_to "Delete", recap_path(@recap), class: "btn btn-action", method: :delete, data: { confirm: "Are you sure you want to delete this recap?"} %>
<% else %>
  <p class="btn btn-action">Add recap to my library</p>
<% end %>

<!--Edit recap-->
<% if @recap.user == current_user %>
  <%= link_to "Edit recap", edit_recap_path(@recap), class: "btn btn-action" %>
<% end %>
